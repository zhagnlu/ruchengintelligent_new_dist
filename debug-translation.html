<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Translation Debug Tool</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #0074c2;
      padding-bottom: 10px;
    }
    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    button {
      background: #0074c2;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
    }
    button:hover {
      background: #0056b3;
    }
    button.secondary {
      background: #6c757d;
    }
    select {
      padding: 10px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 5px;
    }
    .result {
      margin-top: 10px;
      padding: 15px;
      border-radius: 5px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 600px;
      overflow-y: auto;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
    }
    tr:hover {
      background: #f8f9fa;
    }
    .missing {
      background: #fff3cd !important;
    }
    .found {
      background: #d4edda !important;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-card.success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    .stat-card.warning {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .stat-number {
      font-size: 36px;
      font-weight: bold;
      margin: 10px 0;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    .text-preview {
      max-width: 400px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <h1>ğŸ” ç¿»è¯‘ç³»ç»Ÿå®æ—¶è°ƒè¯•å·¥å…·</h1>

  <div class="section">
    <h2>ğŸ“‹ æµ‹è¯•æ§åˆ¶</h2>
    <div class="controls">
      <select id="pageSelect">
        <option value="index.html">é¦–é¡µ (index.html)</option>
        <option value="about.html">å…³äº (about.html)</option>
        <option value="product.html">äº§å“ (product.html)</option>
        <option value="service.html">æœåŠ¡ (service.html)</option>
        <option value="blog.html">åšå®¢ (blog.html)</option>
        <option value="contact.html">è”ç³» (contact.html)</option>
      </select>
      <select id="langSelect">
        <option value="zh">ä¸­æ–‡</option>
        <option value="es">è¥¿ç­ç‰™è¯­</option>
        <option value="fr">æ³•è¯­</option>
        <option value="de">å¾·è¯­</option>
        <option value="ja">æ—¥è¯­</option>
        <option value="ar">é˜¿æ‹‰ä¼¯è¯­</option>
        <option value="ru">ä¿„è¯­</option>
      </select>
      <button onclick="scanPage()">æ‰«æå½“å‰é¡µé¢</button>
      <button onclick="scanSelectedPage()" class="secondary">æ‰«æé€‰å®šé¡µé¢</button>
      <button onclick="exportMissing()" class="secondary">å¯¼å‡ºç¼ºå¤±æ–‡æœ¬</button>
    </div>
  </div>

  <div class="section" id="statsSection" style="display: none;">
    <h2>ğŸ“Š ç»Ÿè®¡æ•°æ®</h2>
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">æ€»æ–‡æœ¬æ•°</div>
        <div class="stat-number" id="totalCount">0</div>
      </div>
      <div class="stat-card success">
        <div class="stat-label">å·²æœ‰ç¿»è¯‘</div>
        <div class="stat-number" id="foundCount">0</div>
      </div>
      <div class="stat-card warning">
        <div class="stat-label">ç¼ºå¤±ç¿»è¯‘</div>
        <div class="stat-number" id="missingCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">å®Œæˆåº¦</div>
        <div class="stat-number" id="percentage">0%</div>
      </div>
    </div>
  </div>

  <div class="section" id="resultsSection" style="display: none;">
    <h2>ğŸ“ è¯¦ç»†ç»“æœ</h2>
    <div id="results"></div>
  </div>

  <script src="js/translator.min.js?v=618922ba"></script>
  <script>
    let translator;
    let currentResults = [];

    // åˆå§‹åŒ–ç¿»è¯‘å™¨
    async function initTranslator() {
      if (!translator) {
        translator = new Translator({
          defaultLang: 'en',
          batchSize: 3,
          delay: 100,
          elements: '[data-translate]'
        });

        // ç­‰å¾…å­—å…¸åŠ è½½
        await new Promise(resolve => setTimeout(resolve, 2000));
      }
      return translator;
    }

    // æ‰«æå½“å‰é¡µé¢
    async function scanPage() {
      const lang = document.getElementById('langSelect').value;
      await scanPageForLanguage(window.location.pathname.split('/').pop() || 'debug-translation.html', lang);
    }

    // æ‰«æé€‰å®šçš„é¡µé¢
    async function scanSelectedPage() {
      const page = document.getElementById('pageSelect').value;
      const lang = document.getElementById('langSelect').value;
      await scanPageForLanguage(page, lang);
    }

    // æ‰«ææŒ‡å®šé¡µé¢å’Œè¯­è¨€
    async function scanPageForLanguage(page, lang) {
      document.getElementById('results').innerHTML = '<div class="info">æ­£åœ¨æ‰«æ...</div>';
      document.getElementById('statsSection').style.display = 'block';
      document.getElementById('resultsSection').style.display = 'block';

      try {
        // åˆå§‹åŒ–ç¿»è¯‘å™¨
        await initTranslator();

        // æ£€æŸ¥å­—å…¸æ˜¯å¦åŠ è½½
        if (!translator.dictionaries[lang]) {
          throw new Error(`å­—å…¸ ${lang}.json æœªåŠ è½½`);
        }

        const dictionary = translator.dictionaries[lang];

        // è·å–é¡µé¢å†…å®¹
        const response = await fetch(page);
        const html = await response.text();

        // æå–æ‰€æœ‰ data-translate æ–‡æœ¬
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const elements = doc.querySelectorAll('[data-translate]');

        const results = [];
        let foundCount = 0;
        let missingCount = 0;

        elements.forEach(element => {
          const text = element.textContent.trim();
          const normalizedText = text.replace(/\s+/g, ' ').trim();

          // æ£€æŸ¥å­—å…¸
          const found = dictionary[text] || dictionary[normalizedText];

          results.push({
            original: text,
            normalized: normalizedText,
            found: !!found,
            translation: found || 'ã€ç¼ºå¤±ã€‘'
          });

          if (found) {
            foundCount++;
          } else {
            missingCount++;
          }
        });

        currentResults = results;

        // æ›´æ–°ç»Ÿè®¡
        const total = results.length;
        document.getElementById('totalCount').textContent = total;
        document.getElementById('foundCount').textContent = foundCount;
        document.getElementById('missingCount').textContent = missingCount;
        document.getElementById('percentage').textContent =
          total > 0 ? `${((foundCount / total) * 100).toFixed(1)}%` : '0%';

        // æ˜¾ç¤ºç»“æœè¡¨æ ¼
        displayResults(results, page, lang);

      } catch (error) {
        document.getElementById('results').innerHTML =
          `<div class="error">é”™è¯¯ï¼š${error.message}</div>`;
      }
    }

    // æ˜¾ç¤ºç»“æœ
    function displayResults(results, page, lang) {
      const missing = results.filter(r => !r.found);
      const found = results.filter(r => r.found);

      let html = `<h3>ğŸ“„ é¡µé¢ï¼š${page} | ğŸŒ è¯­è¨€ï¼š${lang}</h3>`;

      if (missing.length > 0) {
        html += `<h4 style="color: #856404;">âš ï¸ ç¼ºå¤±ç¿»è¯‘ï¼ˆ${missing.length} ä¸ªï¼‰</h4>`;
        html += '<table>';
        html += '<tr><th>#</th><th>åŸæ–‡</th><th>è§„èŒƒåŒ–å</th><th>çŠ¶æ€</th></tr>';

        missing.forEach((item, index) => {
          html += `<tr class="missing">
            <td>${index + 1}</td>
            <td><div class="text-preview" title="${escapeHtml(item.original)}">${escapeHtml(item.original.substring(0, 50))}${item.original.length > 50 ? '...' : ''}</div></td>
            <td><div class="text-preview" title="${escapeHtml(item.normalized)}">${escapeHtml(item.normalized.substring(0, 50))}${item.normalized.length > 50 ? '...' : ''}</div></td>
            <td style="color: #721c24; font-weight: bold;">ç¼ºå¤±</td>
          </tr>`;
        });

        html += '</table>';
      }

      if (found.length > 0) {
        html += `<h4 style="color: #155724; margin-top: 30px;">âœ… å·²æœ‰ç¿»è¯‘ï¼ˆ${found.length} ä¸ªï¼‰</h4>`;
        html += '<details><summary>ç‚¹å‡»æŸ¥çœ‹å·²ç¿»è¯‘çš„æ–‡æœ¬</summary>';
        html += '<table>';
        html += '<tr><th>#</th><th>åŸæ–‡</th><th>ç¿»è¯‘</th></tr>';

        found.slice(0, 20).forEach((item, index) => {
          html += `<tr class="found">
            <td>${index + 1}</td>
            <td><div class="text-preview">${escapeHtml(item.original.substring(0, 40))}${item.original.length > 40 ? '...' : ''}</div></td>
            <td><div class="text-preview">${escapeHtml(item.translation.substring(0, 40))}${item.translation.length > 40 ? '...' : ''}</div></td>
          </tr>`;
        });

        if (found.length > 20) {
          html += `<tr><td colspan="3" style="text-align: center; color: #666;">... è¿˜æœ‰ ${found.length - 20} ä¸ª</td></tr>`;
        }

        html += '</table></details>';
      }

      document.getElementById('results').innerHTML = html;
    }

    // å¯¼å‡ºç¼ºå¤±æ–‡æœ¬
    function exportMissing() {
      if (!currentResults || currentResults.length === 0) {
        alert('è¯·å…ˆæ‰«æé¡µé¢');
        return;
      }

      const missing = currentResults.filter(r => !r.found);

      if (missing.length === 0) {
        alert('æ²¡æœ‰ç¼ºå¤±çš„ç¿»è¯‘ï¼');
        return;
      }

      // ç”Ÿæˆ JSON æ ¼å¼
      let json = '{\n';
      missing.forEach((item, index) => {
        const key = item.normalized;
        json += `  "${key.replace(/"/g, '\\"')}": "ã€éœ€è¦ç¿»è¯‘ã€‘"${index < missing.length - 1 ? ',' : ''}\n`;
      });
      json += '}';

      // ä¸‹è½½æ–‡ä»¶
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'missing_translations.json';
      a.click();
      URL.revokeObjectURL(url);

      alert(`å·²å¯¼å‡º ${missing.length} ä¸ªç¼ºå¤±ç¿»è¯‘åˆ° missing_translations.json`);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('load', async () => {
      console.log('åˆå§‹åŒ–ç¿»è¯‘è°ƒè¯•å·¥å…·...');
      await initTranslator();
      console.log('ç¿»è¯‘å™¨å·²åŠ è½½ï¼Œå­—å…¸çŠ¶æ€ï¼š', translator.getCacheStats());
    });
  </script>
</body>
</html>
